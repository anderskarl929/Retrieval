<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1X2 Ã–vningsfrÃ¥gor - Historia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .upload-section {
            text-align: center;
            padding: 40px;
            border: 3px dashed #667eea;
            border-radius: 15px;
            margin-bottom: 30px;
            background: #f8f9ff;
        }

        .upload-section h2 {
            color: #555;
            margin-bottom: 20px;
        }

        input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .quiz-section {
            display: none;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 10px;
            border-radius: 5px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .question-counter {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .question-box {
            background: #f8f9ff;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .question-text {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option {
            background: white;
            border: 2px solid #ddd;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1em;
        }

        .option:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option.correct {
            background: #d4edda;
            border-color: #28a745;
            cursor: default;
        }

        .option.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            cursor: default;
        }

        .option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            text-align: center;
            display: none;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .next-btn {
            background: #667eea;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 20px;
            display: none;
            transition: all 0.3s;
        }

        .next-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .results-section {
            display: none;
            text-align: center;
        }

        .score-display {
            font-size: 3em;
            color: #667eea;
            margin: 30px 0;
            font-weight: bold;
        }

        .score-message {
            font-size: 1.5em;
            color: #555;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #667eea;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 2em;
            color: #333;
            font-weight: bold;
        }

        .detailed-results {
            text-align: left;
            margin: 30px 0;
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
        }

        .detailed-results h3 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .result-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }

        .result-item.correct {
            border-left-color: #28a745;
        }

        .result-item.incorrect {
            border-left-color: #dc3545;
        }

        .result-item .question-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .result-item .answer-info {
            font-size: 0.95em;
            color: #666;
        }

        .result-item .your-answer {
            color: #dc3545;
        }

        .result-item .correct-answer {
            color: #28a745;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .restart-btn, .download-btn {
            background: #28a745;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .download-btn {
            background: #667eea;
        }

        .restart-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .download-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .instructions {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #856404;
        }

        .instructions strong {
            display: block;
            margin-bottom: 10px;
        }

        .login-section {
            text-align: center;
            padding: 40px;
            border-radius: 15px;
            background: #f8f9ff;
        }

        .login-section h2 {
            color: #555;
            margin-bottom: 20px;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: #555;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-group input[type="text"],
        .form-group input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            background: #667eea;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .login-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .student-info {
            background: #e8f4f8;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            color: #555;
            font-weight: bold;
        }

        .config-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .config-section h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .config-section small {
            color: #856404;
            font-size: 0.85em;
        }

        .upload-section {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“š Historia - Ã–vningsfrÃ¥gor</h1>

        <div class="login-section" id="loginSection">
            <h2>VÃ¤lkommen!</h2>
            <div class="login-form">
                <div class="config-section">
                    <h3>LÃ¤rarinstÃ¤llningar</h3>
                    <div class="form-group">
                        <label for="sheetsUrl">Google Sheets Web App URL (lÃ¤raren fyller i detta):</label>
                        <input type="url" id="sheetsUrl" placeholder="https://script.google.com/macros/s/..." />
                        <small>LÃ¤mna tomt om du inte har konfigurerat Google Sheets</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="studentName">Ditt namn:</label>
                    <input type="text" id="studentName" placeholder="Skriv ditt fÃ¶r- och efternamn" required />
                </div>
                <button class="login-btn" onclick="login()">Starta Quiz</button>
            </div>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="student-info" id="studentInfoUpload"></div>
            <h2>Ladda upp din frÃ¥gefil</h2>
            <div class="instructions">
                <strong>CSV-format:</strong>
                FrÃ¥ga, Alternativ 1, Alternativ 2, Alternativ 3, RÃ¤tt svar (1/2/3)
            </div>
            <input type="file" id="fileInput" accept=".csv">
            <label for="fileInput">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    VÃ¤lj CSV-fil
                </button>
            </label>
        </div>

        <div class="quiz-section" id="quizSection">
            <div class="student-info" id="studentInfoQuiz"></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="question-counter" id="questionCounter"></div>
            <div class="question-box">
                <div class="question-text" id="questionText"></div>
                <div class="options" id="optionsContainer"></div>
                <div class="feedback" id="feedback"></div>
                <button class="next-btn" id="nextBtn">NÃ¤sta frÃ¥ga â†’</button>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <h2>ðŸŽ‰ Quiz Klar!</h2>
            <div class="score-display" id="scoreDisplay"></div>
            <div class="score-message" id="scoreMessage"></div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>RÃ¤tta Svar</h3>
                    <div class="value" id="correctCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>Felaktiga Svar</h3>
                    <div class="value" id="incorrectCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Tid</h3>
                    <div class="value" id="totalTime">0:00</div>
                </div>
                <div class="stat-card">
                    <h3>Betyg</h3>
                    <div class="value" id="grade">-</div>
                </div>
            </div>

            <div class="detailed-results">
                <h3>ðŸ“‹ Detaljerad GenomgÃ¥ng</h3>
                <div id="detailedResultsContainer"></div>
            </div>

            <div class="button-group">
                <button class="download-btn" onclick="downloadResults()">ðŸ“¥ Ladda ner Resultat</button>
                <button class="restart-btn" onclick="location.reload()">ðŸ”„ BÃ¶rja om</button>
            </div>
        </div>
    </div>

    <script>
        let questions = [];
        let currentQuestion = 0;
        let score = 0;
        let answered = false;
        let userAnswers = [];
        let startTime = null;
        let endTime = null;
        let studentName = '';
        let googleSheetsUrl = '';

        function login() {
            const nameInput = document.getElementById('studentName');
            const urlInput = document.getElementById('sheetsUrl');

            studentName = nameInput.value.trim();

            if (!studentName) {
                alert('VÃ¤nligen ange ditt namn!');
                return;
            }

            googleSheetsUrl = urlInput.value.trim();

            // Show upload section
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';

            // Display student name
            const studentInfo = `Inloggad som: ${studentName}`;
            document.getElementById('studentInfoUpload').textContent = studentInfo;
            document.getElementById('studentInfoQuiz').textContent = studentInfo;
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    parseCSV(event.target.result);
                };
                reader.readAsText(file);
            }
        });

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            questions = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    // Split by comma but respect quoted fields
                    const parts = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                    if (parts && parts.length >= 5) {
                        const question = {
                            text: parts[0].replace(/^"|"$/g, '').trim(),
                            options: [
                                parts[1].replace(/^"|"$/g, '').trim(),
                                parts[2].replace(/^"|"$/g, '').trim(),
                                parts[3].replace(/^"|"$/g, '').trim()
                            ],
                            correct: parseInt(parts[4].replace(/^"|"$/g, '').trim()) - 1
                        };
                        questions.push(question);
                    }
                }
            }

            if (questions.length > 0) {
                startQuiz();
            } else {
                alert('Kunde inte lÃ¤sa nÃ¥gra frÃ¥gor frÃ¥n filen. Kontrollera formatet.');
            }
        }

        function startQuiz() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('quizSection').style.display = 'block';
            startTime = new Date();
            userAnswers = [];
            showQuestion();
        }

        function showQuestion() {
            answered = false;
            const question = questions[currentQuestion];
            
            document.getElementById('questionCounter').textContent = 
                `FrÃ¥ga ${currentQuestion + 1} av ${questions.length}`;
            
            document.getElementById('questionText').textContent = question.text;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(optionDiv);
            });

            document.getElementById('feedback').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            
            updateProgress();
        }

        function selectAnswer(selectedIndex) {
            if (answered) return;

            answered = true;
            const question = questions[currentQuestion];
            const options = document.querySelectorAll('.option');
            const feedback = document.getElementById('feedback');

            options.forEach(option => option.classList.add('disabled'));

            const isCorrect = selectedIndex === question.correct;

            // Store user's answer
            userAnswers.push({
                questionText: question.text,
                options: question.options,
                userAnswer: selectedIndex,
                correctAnswer: question.correct,
                isCorrect: isCorrect
            });

            if (isCorrect) {
                options[selectedIndex].classList.add('correct');
                feedback.className = 'feedback correct';
                feedback.textContent = 'âœ“ RÃ¤tt svar!';
                score++;
            } else {
                options[selectedIndex].classList.add('incorrect');
                options[question.correct].classList.add('correct');
                feedback.className = 'feedback incorrect';
                feedback.textContent = 'âœ— Fel svar. RÃ¤tt svar markerat i grÃ¶nt.';
            }

            feedback.style.display = 'block';
            document.getElementById('nextBtn').style.display = 'block';
        }

        function updateProgress() {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        document.getElementById('nextBtn').addEventListener('click', function() {
            currentQuestion++;
            if (currentQuestion < questions.length) {
                showQuestion();
            } else {
                showResults();
            }
        });

        function showResults() {
            endTime = new Date();
            document.getElementById('quizSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';

            const percentage = Math.round((score / questions.length) * 100);
            const incorrectCount = questions.length - score;

            // Calculate time
            const timeDiff = Math.floor((endTime - startTime) / 1000);
            const minutes = Math.floor(timeDiff / 60);
            const seconds = timeDiff % 60;
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Determine grade
            let grade = '';
            if (percentage >= 90) grade = 'A';
            else if (percentage >= 80) grade = 'B';
            else if (percentage >= 70) grade = 'C';
            else if (percentage >= 60) grade = 'D';
            else if (percentage >= 50) grade = 'E';
            else grade = 'F';

            // Update score display
            document.getElementById('scoreDisplay').textContent =
                `${score} / ${questions.length} (${percentage}%)`;

            let message = '';
            if (percentage === 100) {
                message = 'ðŸŒŸ Perfekt! Du har full koll!';
            } else if (percentage >= 80) {
                message = 'ðŸ‘ Mycket bra jobbat!';
            } else if (percentage >= 60) {
                message = 'ðŸ‘ Bra kÃ¤mpat!';
            } else {
                message = 'ðŸ“– FortsÃ¤tt Ã¶va, du lÃ¤r dig mer fÃ¶r varje gÃ¥ng!';
            }

            document.getElementById('scoreMessage').textContent = message;

            // Update statistics
            document.getElementById('correctCount').textContent = score;
            document.getElementById('incorrectCount').textContent = incorrectCount;
            document.getElementById('totalTime').textContent = timeString;
            document.getElementById('grade').textContent = grade;

            // Generate detailed results
            const detailedContainer = document.getElementById('detailedResultsContainer');
            detailedContainer.innerHTML = '';

            userAnswers.forEach((answer, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${answer.isCorrect ? 'correct' : 'incorrect'}`;

                const questionTitle = document.createElement('div');
                questionTitle.className = 'question-title';
                questionTitle.textContent = `${index + 1}. ${answer.questionText}`;

                const answerInfo = document.createElement('div');
                answerInfo.className = 'answer-info';

                if (answer.isCorrect) {
                    answerInfo.innerHTML = `âœ“ <span class="correct-answer">RÃ¤tt! Ditt svar: ${answer.options[answer.userAnswer]}</span>`;
                } else {
                    answerInfo.innerHTML = `âœ— <span class="your-answer">Ditt svar: ${answer.options[answer.userAnswer]}</span><br>` +
                        `<span class="correct-answer">RÃ¤tt svar: ${answer.options[answer.correctAnswer]}</span>`;
                }

                resultItem.appendChild(questionTitle);
                resultItem.appendChild(answerInfo);
                detailedContainer.appendChild(resultItem);
            });

            // Send results to Google Sheets
            sendResultsToGoogleSheets(percentage, grade, timeString);
        }

        async function sendResultsToGoogleSheets(percentage, grade, timeString) {
            if (!googleSheetsUrl) {
                console.log('Google Sheets URL inte konfigurerad, hoppar Ã¶ver sparande');
                return;
            }

            try {
                const data = {
                    timestamp: new Date().toLocaleString('sv-SE'),
                    studentName: studentName,
                    totalQuestions: questions.length,
                    correctAnswers: score,
                    incorrectAnswers: questions.length - score,
                    percentage: percentage,
                    grade: grade,
                    timeSpent: timeString,
                    details: userAnswers.map((answer, index) => ({
                        questionNumber: index + 1,
                        question: answer.questionText,
                        studentAnswer: answer.options[answer.userAnswer],
                        correctAnswer: answer.options[answer.correctAnswer],
                        isCorrect: answer.isCorrect
                    }))
                };

                const response = await fetch(googleSheetsUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                console.log('Resultat skickade till Google Sheets');
            } catch (error) {
                console.error('Fel vid skickande till Google Sheets:', error);
            }
        }

        function downloadResults() {
            const percentage = Math.round((score / questions.length) * 100);
            const timeDiff = Math.floor((endTime - startTime) / 1000);
            const minutes = Math.floor(timeDiff / 60);
            const seconds = timeDiff % 60;
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            let grade = '';
            if (percentage >= 90) grade = 'A';
            else if (percentage >= 80) grade = 'B';
            else if (percentage >= 70) grade = 'C';
            else if (percentage >= 60) grade = 'D';
            else if (percentage >= 50) grade = 'E';
            else grade = 'F';

            // Create CSV content
            let csvContent = 'RESULTATSAMMANFATTNING\n\n';
            csvContent += `Datum,${new Date().toLocaleDateString('sv-SE')}\n`;
            csvContent += `Tid,${new Date().toLocaleTimeString('sv-SE')}\n`;
            csvContent += `Total tid,${timeString}\n`;
            csvContent += `Antal frÃ¥gor,${questions.length}\n`;
            csvContent += `RÃ¤tt svar,${score}\n`;
            csvContent += `Fel svar,${questions.length - score}\n`;
            csvContent += `Procent,${percentage}%\n`;
            csvContent += `Betyg,${grade}\n\n`;

            csvContent += 'DETALJERADE SVAR\n';
            csvContent += 'FrÃ¥ga,Ditt svar,RÃ¤tt svar,Resultat\n';

            userAnswers.forEach((answer, index) => {
                const questionText = answer.questionText.replace(/,/g, ';');
                const userAnswerText = answer.options[answer.userAnswer].replace(/,/g, ';');
                const correctAnswerText = answer.options[answer.correctAnswer].replace(/,/g, ';');
                const result = answer.isCorrect ? 'RÃ¤tt' : 'Fel';

                csvContent += `"${questionText}","${userAnswerText}","${correctAnswerText}",${result}\n`;
            });

            // Create download
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            link.setAttribute('href', url);
            link.setAttribute('download', `quiz_resultat_${timestamp}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
